<!doctype html>
<html lang="en" xmlns:th="http://thymeleaf.org">
<head th:replace="partial/header :: head(${pageTitle})"></head>
<body>
<div class="container-fluid">
    <div th:replace="partial/header :: menu"></div>
    <div class="content">
        <h2>Manager Users | <span th:text="${pageTitle}">Create new user</span></h2>
        <form class="m-auto" enctype="multipart/form-data" id="formUser" method="post" style="max-width: 750px"
              th:action="@{/users/save}" th:object="${user}">
            <input th:field="*{id}" type="hidden">
            <div class="border border-success rounded p-3">
                <div class="mb-3 row">
                    <div class="col-sm-4 col-form-label">Email:</div>
                    <div class="col-sm-8">
                        <input class="form-control" maxlength="128" minlength="8"
                               required th:field="*{email}" type="email">
                    </div>
                </div>

                <div class="mb-3 row">
                    <div class="col-sm-4 col-form-label">First Name:</div>
                    <div class="col-sm-8">
                        <input class="form-control" maxlength="45" minlength="2"
                               required th:field="*{firstName}" type="text">
                    </div>
                </div>

                <div class="mb-3 row">
                    <div class="col-sm-4 col-form-label">Last Name:</div>
                    <div class="col-sm-8">
                        <input class="form-control" maxlength="45" minlength="2"
                               required th:field="*{lastName}" type="text">
                    </div>
                </div>

                <div class="mb-3 row">
                    <div class="col-sm-4 col-form-label">Password:</div>
                    <div class="col-sm-8">
                        <input class="form-control" maxlength="20"
                               minlength="8" placeholder="Place empty if you don't want to change password"
                               th:field="*{password}" th:if="${user.id}" type="password">
                        <input class="form-control" maxlength="20" minlength="8" required
                               th:field="*{password}" th:unless="${user.id}" type="password">
                    </div>
                </div>

                <div class="mb-3 row">
                    <div class="col-sm-4 col-form-label">Roles:</div>
                    <div class="col-sm-8">
                        <th:block th:each="role:${roles}">
                            <label>
                                <input class="m-2" th:field="*{roles}" th:text="${role.name}"
                                       th:value="${role.id}" type="checkbox"/>
                                - <small>[[${role.description}]]</small>
                            </label>

                            <br>
                        </th:block>
                    </div>
                </div>

                <div class="mb-3 row">
                    <div class="col-sm-4 col-form-label">Enabled:</div>
                    <div class="col-sm-8">
                        <input class="form-check" th:field="*{enabled}" type="checkbox"/>
                    </div>
                </div>

                <div class="mb-3 row">
                    <div class="col-sm-4 col-form-label">Photos:</div>
                    <div class="col-sm-8">
                        <input th:field="*{photos}" type="hidden">
                        <input accept="image/png, image/jpg" class="form-file" id="fileImage" name="image" type="file"/>
                        <img alt="Photos preview" class="img-fluid" id="thumbnail" th:src="@{${user.photosImagePath}}"/>
                    </div>
                </div>


                <div class="text-center mt-4">
                    <button class="btn btn-primary m-3" id="btnSubmit" type="submit">Save</button>
                    <button class="btn btn-secondary" id="btnCancel">Cancel</button>
                </div>
            </div>
        </form>
        <div class="modal fade text-center" id="modalDialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">Modal title</h5>
                        <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                    </div>
                    <div class="modal-body">
                        <p id="modalContent">Modal body text goes here.</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-danger" data-bs-dismiss="modal" type="button">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div th:replace="partial/footer :: footer"></div>
</div>
<div th:replace="partial/footer :: script"></div>
<script>
    $(function () {
        $('#btnCancel').click(function () {
            window.location = '[[@{/users}]]';
        })

        $('#fileImage').change(function () {
            const fileSize = this.files[0].size;
            if (fileSize > 1048576) {
                this.setCustomValidity("You must choose an image less than 1MB!");
                    this.reportValidity();
                } else {
                    this.setCustomValidity("");
                    showImageThumbnail(this);
                }

            })


            $('#btnSubmit').click(function (e) {
                e.preventDefault();
                const params = {
                    id: $('#id').val(),
                    email: $('#email').val()
                }

                $.post("[[@{/users/check_email}]]", params)
                    .done(function (data) {
                        if (data) {
                            $('#formUser').submit();
                        } else {
                            showModal('Warning', 'There are another user with email ' + $('#email').val());
                        }
                    })
                    .fail(function (e) {
                        showModal('Error', 'Service unavailable');
                        console.log(e);
                    });
            })


            function showModal(title, message) {
                $('#modalTitle').text(title)
                $('#modalContent').text(message)
                $('#modalDialog').modal('show');
            }
        })

    function showImageThumbnail(fileInput) {
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = function (e) {
            $('#thumbnail').attr('src', e.target.result);
        }
        reader.readAsDataURL(file);
    }
</script>
</body>
</html>